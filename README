==========================================
        CONFIGURAR NGIX DESPLIEGUE
==========================================

# Instalar Nginx y Certbot
sudo apt update && sudo apt install -y nginx certbot python3-certbot-nginx

# Crear configuraciÃ³n temporal de Nginx
sudo tee /etc/nginx/sites-available/findata.lat > /dev/null <<'EOF'
server {
    listen 80;
    listen [::]:80;
    server_name findata.lat www.findata.lat;
    
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF

# Habilitar el sitio
sudo ln -sf /etc/nginx/sites-available/findata.lat /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# Verificar y reiniciar Nginx
sudo nginx -t && sudo systemctl restart nginx

# Obtener certificado SSL - CAMBIA EL EMAIL
sudo certbot --nginx -d findata.lat -d www.findata.lat --email tu-email@ejemplo.com --agree-tos --non-interactive

# Crear configuraciÃ³n final con SSL
sudo tee /etc/nginx/sites-available/findata.lat > /dev/null <<'EOF'
server {
    listen 80;
    listen [::]:80;
    server_name findata.lat www.findata.lat;
    
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }
    
    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name findata.lat www.findata.lat;
    
    ssl_certificate /etc/letsencrypt/live/findata.lat/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/findata.lat/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    client_max_body_size 50M;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
EOF

# Recargar Nginx
sudo nginx -t && sudo systemctl reload nginx

# Verificar renovaciÃ³n automÃ¡tica
sudo certbot renew --dry-run

echo "âœ… COMPLETADO - Visita https://findata.lat"


==========================================
           EJECUTAR APP ENTORNO DEV
==========================================

EJECUTAR APP: docker-compose up --build

VER LOGS: docker-compose logs -f

DESACTIVAR APP: docker-compose down 

DESMOTAR VOLUMENES( no usar esto si ya se esta corriedo la db del mvp con regitros reales): docker-compose down -v



==========================================
           EJECUTAR APP ENTORNO PROD
==========================================

EJECUTAR APP: sudo docker-compose -f docker-compose.prod.yml up -d --build

VER LOGS: sudo docker-compose -f docker-compose.prod.yml logs -f

VER LOGS DE UN SERVICIO ESPECÃFICO: sudo docker-compose -f docker-compose.prod.yml logs -f findata_app_prod

DETENER APP: sudo docker-compose -f docker-compose.prod.yml down

REINICIAR APP: sudo docker-compose -f docker-compose.prod.yml restart

RECONSTRUIR IMAGEN (despuÃ©s de cambios en cÃ³digo): sudo docker-compose -f docker-compose.prod.yml up -d --build --force-recreate

VER ESTADO DE CONTENEDORES: sudo docker-compose -f docker-compose.prod.yml ps

EJECUTAR COMANDO DENTRO DEL CONTENEDOR: sudo docker-compose -f docker-compose.prod.yml exec findata_app_prod bash

LIMPIAR RECURSOS NO UTILIZADOS: sudo docker system prune -a

==========================================
NOTA: El flag -d ejecuta en modo detached (background)
==========================================


==========================================
  EJECUTAR ESTO CUNDO ESTE MONTADA LA DB
==========================================
APENAS SE DESPLIEGUE EJECUTAR ESTO 

INSERT INTO entity (name_rol)
VALUES 
    ('Admin'),    -- para Finadmin
    ('Partner')   -- para Finpartnerts (Socio)
RETURNING id, name_rol;





==========================================
    FLUJO DE ACTUALIZACIÃ“N - FINDATA PROD
==========================================

# 1ï¸âƒ£ NAVEGAR AL DIRECTORIO DEL PROYECTO
cd findata_app

# 2ï¸âƒ£ DETENER LA APLICACIÃ“N (libera recursos)
sudo docker-compose -f docker-compose.prod.yml down

# 3ï¸âƒ£ HACER PULL DE LOS CAMBIOS DESDE GIT
git pull origin main
# O si usas otra rama: git pull origin nombre-de-tu-rama

# 4ï¸âƒ£ RECONSTRUIR Y LEVANTAR LA APLICACIÃ“N
sudo docker-compose -f docker-compose.prod.yml up -d --build

# 5ï¸âƒ£ VERIFICAR QUE EL CONTENEDOR ESTÃ CORRIENDO
sudo docker-compose -f docker-compose.prod.yml ps

# 6ï¸âƒ£ VER LOGS DE LA APLICACIÃ“N (verificar que iniciÃ³ correctamente)
sudo docker-compose -f docker-compose.prod.yml logs -f findata_app_prod
# Presiona Ctrl+C para salir de los logs

# 7ï¸âƒ£ REINICIAR NGINX (por si acaso)
sudo systemctl restart nginx

# 8ï¸âƒ£ VERIFICAR ESTADO DE NGINX
sudo systemctl status nginx

# 9ï¸âƒ£ TEST DE CONEXIÃ“N CON CURL
curl -I https://findata.lat
# DeberÃ­as ver: HTTP/2 200

# ðŸ”Ÿ TEST COMPLETO (opcional - ver respuesta HTML)
curl -k https://findata.lat

==========================================
    VERIFICACIONES ADICIONALES
==========================================

# Ver logs en tiempo real de Nginx
sudo tail -f /var/log/nginx/error.log

# Ver logs en tiempo real de tu app
sudo docker-compose -f docker-compose.prod.yml logs -f

# Verificar puertos en uso
sudo netstat -tlnp | grep -E ':(80|443|8080)'

# Inspeccionar el contenedor
sudo docker inspect findata_app_prod

==========================================